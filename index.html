<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>NicheCom Handover Packet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        :root { --primary: #333; }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            overscroll-behavior: none; 
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            min-height: 80vh;
        }
        
        /* --- NAVIGATION --- */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #333; }
        .tab-btn {
            padding: 15px 30px;
            background: #ddd;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin-right: 5px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        .tab-btn.active { background: #333; color: white; }
        .tab-content { display: none; padding: 20px 0; }
        .tab-content.active { display: block; }

        /* --- SCREEN MODE STYLES --- */
        h2 { margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 5px; font-size: 24px; }
        h3 { margin-top: 15px; border-bottom: 1px solid #999; padding-bottom: 2px; font-size: 16px; background: #f4f4f4; padding: 5px; }
        
        /* Borders */
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 14px; }
        th, td { border: 1px solid #999; padding: 6px; text-align: left; vertical-align: middle; }
        th { background-color: #f8f8f8; font-weight: bold; }
        
        input, select, textarea {
            width: 95%; padding: 4px; border: none; background: transparent; font-family: inherit; font-size: 14px;
        }
        /* iOS Input Fix */
        input[type="radio"] { margin: 0; }

        input:focus, textarea:focus { background-color: #eef; outline: none; }
        .uppercase { text-transform: uppercase; }
        .bordered-input { border: 1px solid #ccc !important; background: #fff; padding: 5px; border-radius: 3px; }

        .col-qty { width: 40px; text-align: center; }
        .col-cond { width: 50px; text-align: center; }
        .col-radio { width: 40px; text-align: center; }
        .radio-group { display: flex; align-items: center; gap: 10px; justify-content: flex-start; }
        /* Added flex-shrink: 0 to prevent text squash on iPad */
        .radio-group label { display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap; flex-shrink: 0; }

        .car-canvas-container {
            position: relative;
            width: 100%;
            height: 350px;
            border: 1px solid #999;
            background: url('images/car-diagram.png') no-repeat center center;
            background-size: contain;
            margin-bottom: 15px;
            touch-action: none; 
        }
        #carCanvas { width: 100%; height: 100%; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-header { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;}
        
        .sig-wrapper {
            border: 1px dashed #999;
            background: #fffff0;
            margin-top: 5px;
            height: 100px;
            position: relative;
            touch-action: none; 
        }
        canvas.sig-pad { width: 100%; height: 100%; display: block; }
        .clear-btn {
            position: absolute; bottom: 2px; right: 2px; font-size: 10px; background: #eee; border: 1px solid #999; padding: 2px 5px; cursor: pointer; z-index: 10;
        }

        .actions { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 999; }
        .action-btn { padding: 15px 25px; background: #007bff; color: white; border: none; border-radius: 50px; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        /* Internal Page Break Helper */
        .pdf-page-break { display: none; }

        /* =========================================
           STRICT A4 PDF GENERATION STYLING
           ========================================= */
        body.pdf-mode {
            background: white;
            padding: 0;
            margin: 0;
            width: 210mm;
            /* GLOBAL FORCE TO 10px */
            font-size: 10px !important; 
        }

        /* FORCE ALL TEXT ELEMENTS TO 10px IN PDF MODE */
        body.pdf-mode table, 
        body.pdf-mode input, 
        body.pdf-mode textarea, 
        body.pdf-mode select, 
        body.pdf-mode label, 
        body.pdf-mode p, 
        body.pdf-mode div {
            font-size: 10px !important;
        }
        
        /* HEADERS EXCEPTION */
        body.pdf-mode h2 { font-size: 16px !important; margin-bottom: 10px; border-bottom-width: 1px; }
        body.pdf-mode h3 { font-size: 12px !important; margin-top: 10px; padding: 3px; }

        /* CONTAINER RESET */
        body.pdf-mode .container {
            box-shadow: none;
            padding: 0;
            margin: 0;
            width: 100%;
            max-width: none;
        }
        body.pdf-mode .actions, body.pdf-mode .tabs, body.pdf-mode .clear-btn { display: none !important; }
        
        /* TAB CONTENT */
        body.pdf-mode .tab-content {
            display: block !important;
            width: 100%;
            padding: 10mm 10mm; 
            box-sizing: border-box;
        }

        /* GENERAL PDF TABLE SPACING */
        body.pdf-mode table { margin-bottom: 10px; }
        body.pdf-mode th, body.pdf-mode td { padding: 4px; height: auto; }

        /* KIT TAB */
        body.pdf-mode #kit {
            /* Handled by internal break */
        }

        /* FORCE INTERNAL PAGE BREAK IN KIT */
        body.pdf-mode .pdf-page-break {
            display: block;
            page-break-before: always;
            height: 1px;
            margin: 0;
        }

        /* CAR TAB STYLES */
        body.pdf-mode #car {
            page-break-before: always; /* Force new page for Car Check */
            margin-top: 0;
        }
        
        /* Reduced Diagram Height for PDF Safety */
        body.pdf-mode .car-canvas-container { height: 250px !important; margin-bottom: 5px; }
        
        /* Signatures */
        body.pdf-mode .sig-wrapper { height: 70px; margin-top: 5px; }
        body.pdf-mode .bordered-input { padding: 3px; border-width: 0.5px !important; }
        
        /* Borders */
        body.pdf-mode th, body.pdf-mode td { border-width: 0.5px !important; border-color: #888; }
    </style>
</head>
<body>

<div class="actions">
    <button class="action-btn" onclick="generatePDF()">Download Complete PDF</button>
</div>

<div class="container" id="mainContainer">
    
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('kit', this)">Kit Handover</button>
        <button class="tab-btn" onclick="switchTab('car', this)">Car Inspection</button>
    </div>

    <div id="kit" class="tab-content active">
        <h2>Kit Handover Checklist v1.1</h2>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
             <div style="font-size:inherit; background:#eee; padding:5px; border:1px solid #ccc;">
                <strong>Condition Guide:</strong> 1 = Perfect &nbsp;|&nbsp; 5 = Ruined
             </div>
             <div><strong>Manager:</strong> <input type="text" style="width:150px; border-bottom:1px solid #999"></div>
        </div>

        <h3>OFFICE KIT</h3>
        <table>
            <tr><th width="35%">Item</th><th>Model/Type</th><th>Serial No.</th><th class="col-qty">Qty</th><th class="col-cond">Cond</th><th>Notes</th></tr>
            <tr><td>iPad</td><td><input type="text"></td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Charger</td><td><input type="text"></td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Mobile Phone</td><td><input type="text"></td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Mobile Charger</td><td><input type="text"></td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Fuel Card</td><td><input type="text"></td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
        </table>

        <h3>FLOORPLAN / EPC KIT</h3>
        <table>
            <tr><th width="35%">Item</th><th>Model/Type</th><th class="col-qty">Qty</th><th class="col-cond">Cond</th><th>Notes</th></tr>
            <tr><td>Disto</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Folder/Clipboard</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Backing sheet</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Ruler</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Measuring Wheel</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Compass</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Ladder</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
        </table>

        <h3>PHOTOGRAPHY KIT</h3>
        <table>
            <tr><th width="35%">Item</th><th>Model/Type</th><th class="col-qty">Qty</th><th class="col-cond">Cond</th><th>Notes</th></tr>
            <tr><td>Camera Body</td><td><input type="text" placeholder="e.g. Sony A7iv"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Batt & Charger</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Wide Lens</td><td><input type="text" placeholder="e.g. 12-24mm"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>50mm Lens</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Zoom Lens</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Tripod & Head</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Lens Cloth</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>AAA Charger</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Rech. Batteries</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Cables/Reader</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>SD Cards</td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Camera Bag</td><td><input type="text" placeholder="e.g. Trolley/Backpack"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
        </table>
        
        <div class="pdf-page-break"></div>

        <h3>MATTERPORT KIT</h3>
        <table>
             <tr><th width="35%">Item</th><th class="col-qty">Qty</th><th class="col-cond">Cond</th><th>Notes</th></tr>
             <tr><td>Matterport Camera</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
             <tr><td>Pelicase</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
             <tr><td>Tripod Head</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
             <tr><td>Plate Adapter</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
             <tr><td>Powerpack</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
             <tr><td>4x Doorstops</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
        </table>
        
        <h3>ELEVATED KIT</h3>
        <table>
            <tr><th width="35%">Item</th><th class="col-qty">Qty</th><th class="col-cond">Cond</th><th>Notes</th></tr>
            <tr><td>PhotoMast</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>Phone Mount</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>CamRanger</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>USB Cable</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td>CamRanger Bag</td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
       </table>

       <h3>ADDITIONAL ITEMS</h3>
       <table>
            <tr><th width="35%">Item</th><th>Model/Type</th><th class="col-qty">Qty</th><th class="col-cond">Cond</th><th>Notes</th></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
            <tr><td><input type="text"></td><td><input type="text"></td><td><input type="number"></td><td><input type="number"></td><td><input type="text"></td></tr>
       </table>

        <div class="grid-2">
            <div>
                <p style="margin:2px 0"><strong>Manager Name:</strong> <input type="text" class="bordered-input"></p>
                <div class="sig-wrapper">
                    <canvas id="sig-manager-kit" class="sig-pad"></canvas>
                    <button class="clear-btn" onclick="clearSig('sig-manager-kit')">Clear</button>
                </div>
                <p style="margin:2px 0">Date: <input type="date" class="auto-date bordered-input"></p>
            </div>
            <div>
                <p style="margin:2px 0"><strong>Photographer Name:</strong> <input type="text" class="bordered-input"></p>
                <div class="sig-wrapper">
                    <canvas id="sig-photo-kit" class="sig-pad"></canvas>
                    <button class="clear-btn" onclick="clearSig('sig-photo-kit')">Clear</button>
                </div>
                <p style="margin:2px 0">Date: <input type="date" class="auto-date bordered-input"></p>
            </div>
        </div>
        
        <p style="margin:5px 0"><strong>Notes:</strong> <input type="text" class="bordered-input" style="width:98%"></p>
        <div style="display:flex; gap:20px; font-size:inherit;">
            <label><input type="checkbox" style="width:auto"> Mileage form sent?</label> 
            <label><input type="checkbox" style="width:auto"> Devices Unlocked?</label>
        </div>
        
        <div class="grid-2" style="margin-top:10px;">
             <div>
                <p style="margin:0"><strong>Personal Contact Number:</strong></p>
                <input type="text" class="bordered-input" style="width:95%">
             </div>
             <div>
                <p style="margin:0"><strong>Personal Email Address:</strong></p>
                <input type="text" class="bordered-input" style="width:95%">
             </div>
        </div>
    </div>

    <div id="car" class="tab-content">
        <h2>Company Car Check Sheet v1.1</h2>
        
        <div class="grid-header">
            <div>Reg: <input type="text" class="uppercase" style="border-bottom:1px solid #000"></div>
            <div>Driver: <input type="text" style="border-bottom:1px solid #000"></div>
            <div>Mileage: <input type="number" style="border-bottom:1px solid #000"></div>
            <div>Date: <input type="date" class="auto-date" style="border-bottom:1px solid #000"></div>
        </div>
        <div style="margin-bottom:5px;">Manager: <input type="text" style="border-bottom:1px solid #000; width: 300px;"></div>

        <p style="margin:0; font-size:10px"><em>Mark damage on the diagram below:</em></p>
        <div class="car-canvas-container">
            <canvas id="carCanvas"></canvas>
            <div style="position:absolute; bottom:5px; right:5px;">
                <button onclick="clearCarCanvas()" class="clear-btn">Clear Drawing</button>
            </div>
        </div>

        <h3>Internal Checks</h3>
        <table>
            <tr>
                <td width="30%"><strong>Infotainment Working?</strong></td>
                <td width="25%"> <div class="radio-group">
                       <label><input type="radio" name="info" value="yes"> Yes</label>
                       <label><input type="radio" name="info" value="no"> No</label>
                   </div>
                </td>
                <td>Comment: <input type="text"></td>
            </tr>
            <tr>
                <td><strong>Warning Lights (Red)</strong></td>
                <td>
                   <div class="radio-group">
                       <label><input type="radio" name="warn_red" value="yes"> Yes</label>
                       <label><input type="radio" name="warn_red" value="no"> No</label>
                   </div>
                </td>
                <td>Comment: <input type="text"></td>
            </tr>
            <tr>
                <td><strong>Warning Lights (Amber)</strong></td>
                <td>
                   <div class="radio-group">
                       <label><input type="radio" name="warn_amber" value="yes"> Yes</label>
                       <label><input type="radio" name="warn_amber" value="no"> No</label>
                   </div>
                </td>
                <td>Comment: <input type="text"></td>
            </tr>
            <tr>
                <td><strong>Service History?</strong></td>
                <td colspan="2">Last Date/Mile: <input type="text" style="width:40%"> Next: <input type="text" style="width:40%"></td>
            </tr>
        </table>
        
        <p><strong>Bodywork Comments:</strong> <input type="text" style="width:100%; border-bottom:1px solid black"></p>
        
        <h3>External / Safety Checks</h3>
        <p style="margin-top:-5px; margin-bottom: 2px; font-style:italic; font-size:10px;">Checked?</p>
        <table>
            <tr>
                <th width="30%">Item</th>
                <th class="col-radio">Yes</th>
                <th class="col-radio">No</th>
                <th class="col-radio">N/A</th>
                <th>Action Required/Taken</th>
            </tr>
            <tr><td>Windscreen / Glass</td><td align="center"><input type="radio" name="wind" value="y"></td><td align="center"><input type="radio" name="wind" value="n"></td><td align="center"><input type="radio" name="wind" value="na"></td><td><input type="text"></td></tr>
            <tr><td>Lights / Indicators</td><td align="center"><input type="radio" name="light" value="y"></td><td align="center"><input type="radio" name="light" value="n"></td><td align="center"><input type="radio" name="light" value="na"></td><td><input type="text"></td></tr>
            <tr><td>Mirrors</td><td align="center"><input type="radio" name="mirr" value="y"></td><td align="center"><input type="radio" name="mirr" value="n"></td><td align="center"><input type="radio" name="mirr" value="na"></td><td><input type="text"></td></tr>
            <tr><td>Number Plates</td><td align="center"><input type="radio" name="plate" value="y"></td><td align="center"><input type="radio" name="plate" value="n"></td><td align="center"><input type="radio" name="plate" value="na"></td><td><input type="text"></td></tr>
            <tr><td>Tyres (1.6mm legal)</td><td align="center"><input type="radio" name="tyre" value="y"></td><td align="center"><input type="radio" name="tyre" value="n"></td><td align="center"><input type="radio" name="tyre" value="na"></td><td><input type="text"></td></tr>
            <tr><td>Locking Wheel Nut</td><td align="center"><input type="radio" name="nut" value="y"></td><td align="center"><input type="radio" name="nut" value="n"></td><td align="center"><input type="radio" name="nut" value="na"></td><td><input type="text"></td></tr>
            <tr><td>Spare Wheel</td><td align="center"><input type="radio" name="spare" value="y"></td><td align="center"><input type="radio" name="spare" value="n"></td><td align="center"><input type="radio" name="spare" value="na"></td><td><input type="text"></td></tr>
            <tr><td>Charging Cables</td><td align="center"><input type="radio" name="cable" value="y"></td><td align="center"><input type="radio" name="cable" value="n"></td><td align="center"><input type="radio" name="cable" value="na"></td><td><input type="text"></td></tr>
        </table>

        <div class="grid-2">
            <div>
                <p style="margin:2px 0"><strong>Driver Signature:</strong></p>
                <div class="sig-wrapper">
                    <canvas id="sig-driver-car" class="sig-pad"></canvas>
                    <button class="clear-btn" onclick="clearSig('sig-driver-car')">Clear</button>
                </div>
            </div>
            <div>
                <p style="margin:2px 0"><strong>Manager Signature:</strong></p>
                <div class="sig-wrapper">
                    <canvas id="sig-manager-car" class="sig-pad"></canvas>
                    <button class="clear-btn" onclick="clearSig('sig-manager-car')">Clear</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SETUP & UTILS ---
    function setDates() {
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('.auto-date').forEach(input => { input.value = today; });
    }

    // --- TABS ---
    function switchTab(tabId, btnElement) {
        document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btnElement.classList.add('active');
        setTimeout(() => resizeAllCanvases(), 10);
    }

    // --- CANVAS RESIZING ---
    function resizeAllCanvases() {
        // Signatures
        Object.keys(sigPads).forEach(id => {
            const canvas = document.getElementById(id);
            const pad = sigPads[id];
            if (canvas.offsetWidth > 0) {
                 const ratio = Math.max(window.devicePixelRatio || 1, 1);
                 if (canvas.width !== canvas.offsetWidth * ratio) {
                     const data = pad.toData(); 
                     canvas.width = canvas.offsetWidth * ratio;
                     canvas.height = canvas.offsetHeight * ratio;
                     canvas.getContext("2d").scale(ratio, ratio);
                     pad.fromData(data); 
                 }
            }
        });
        // Car
        if (carCanvas && carCanvas.offsetWidth > 0) {
            if (carCanvas.width !== carCanvas.offsetWidth) {
                carCanvas.width = carCanvas.offsetWidth;
                carCanvas.height = carCanvas.offsetHeight;
                carCtx.strokeStyle = "red";
                carCtx.lineWidth = 3;
            }
        }
    }

    // --- INIT ---
    const sigPads = {};
    const canvasIds = ['sig-manager-kit', 'sig-photo-kit', 'sig-driver-car', 'sig-manager-car'];
    let carCanvas, carCtx;
    
    window.onload = function() {
        setDates(); 
        canvasIds.forEach(id => {
            const canvas = document.getElementById(id);
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            sigPads[id] = new SignaturePad(canvas);
        });
        
        const container = document.querySelector('.car-canvas-container');
        carCanvas = document.getElementById('carCanvas');
        carCanvas.width = container.offsetWidth;
        carCanvas.height = container.offsetHeight;
        carCtx = carCanvas.getContext('2d');
        carCtx.strokeStyle = "red";
        carCtx.lineWidth = 3;
        
        // Touch/Mouse Events for Car Drawing
        function startDraw(e) {
            e.preventDefault(); 
            const rect = carCanvas.getBoundingClientRect();
            let x = (e.touches ? e.touches[0].clientX : e.offsetX) - (e.touches ? rect.left : 0);
            let y = (e.touches ? e.touches[0].clientY : e.offsetY) - (e.touches ? rect.top : 0);
            carCtx.beginPath(); carCtx.moveTo(x, y); carCanvas.isDrawing = true;
        }
        function moveDraw(e) {
            if (!carCanvas.isDrawing) return;
            e.preventDefault(); 
            const rect = carCanvas.getBoundingClientRect();
            let x = (e.touches ? e.touches[0].clientX : e.offsetX) - (e.touches ? rect.left : 0);
            let y = (e.touches ? e.touches[0].clientY : e.offsetY) - (e.touches ? rect.top : 0);
            carCtx.lineTo(x, y); carCtx.stroke();
        }
        function endDraw() { carCanvas.isDrawing = false; }

        carCanvas.addEventListener('mousedown', startDraw);
        carCanvas.addEventListener('mousemove', moveDraw);
        carCanvas.addEventListener('mouseup', endDraw);
        carCanvas.addEventListener('touchstart', startDraw, {passive: false});
        carCanvas.addEventListener('touchmove', moveDraw, {passive: false});
        carCanvas.addEventListener('touchend', endDraw);
    };

    function clearSig(id) { sigPads[id].clear(); }
    function clearCarCanvas() { carCtx.clearRect(0, 0, carCanvas.width, carCanvas.height); }

    // --- PDF GENERATION ---
    async function generatePDF() {
        window.scrollTo(0, 0);
        document.body.classList.add('pdf-mode');
        resizeAllCanvases(); 

        const element = document.getElementById('mainContainer');
        const opt = {
            margin:       0,
            filename:     'NicheCom_Handover_Packet.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['css', 'legacy'] }
        };

        try {
            await html2pdf().set(opt).from(element).save();
        } finally {
            document.body.classList.remove('pdf-mode');
            const activeTabBtn = document.querySelector('.tab-btn.active');
            if(activeTabBtn) {
                 const targetId = activeTabBtn.getAttribute('onclick').match(/'([^']+)'/)[1];
                 switchTab(targetId, activeTabBtn);
            }
        }
    }
</script>

</body>
</html>